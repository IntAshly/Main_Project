{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>NurtureNest - Health Assistant</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">

    <!-- Include your existing CSS links -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@600;700&family=Montserrat:wght@200;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    

    <!-- Libraries Stylesheet -->
    <link href="{% static 'lib/animate/animate.min.css' %}" rel="stylesheet">
    <link href="{% static 'lib/lightbox/css/lightbox.min.css' %}" rel="stylesheet">
    <link href="{% static 'lib/owlcarousel/assets/owl.carousel.min.css' %}" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="{% static 'css/style.css' %}" rel="stylesheet">

    <style>

        .box-container {
            display: flex;
            justify-content: flex-start; /* Aligns items to the start (left) of the container */
            gap: 20px; /* Adjust the gap between the boxes if needed */
            margin-left: -505px; /* Move the container to the left; adjust as needed */
          }
        
        .bg-box-color {
            background-color: rgba(255, 255, 255, 0.2); /* Transparent white background */
            border-left-width: 6px; /* Left border width */
            height: 250px; /* Increased height */
            display: flex;
            justify-content: center;
            align-items: left;
            border-left: 6px solid #FF6F61; /* Border color */
            border-radius: 8px; /* Rounded corners */
            transition: background-color 0.3s, transform 0.3s; /* Smooth transitions */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow for depth */
            width: 100%; /* Width to fit three boxes in a row */
            box-sizing: border-box;
            
        }
        
        .bg-box-color:hover {
            background-color: rgba(255, 255, 255, 0.4); /* Less transparent white on hover */
            transform: translateY(-5px); /* Lift effect on hover */
        }
        
        .no-underline {
            text-decoration: none;
        }
        
        .icon-style {
            font-size: 40px; /* Adjust icon size as needed */
            margin-bottom: 10px; /* Space between icon and text */
        }
        .centered-title {
            text-align: center; /* Center-aligns the text */
            font-weight: bold; /* Makes the text bold */
            font-size: 2.0rem; /* Larger font size for emphasis */
            padding: 10rem; /* Adjust padding to your preference */
            border-bottom: 3px solid #007bff; /* Thicker border for emphasis */
            transform: translateX(-25%); /* Shift the title 10% to the left */
        }
          .larger-bold-text {
            font-size: 1.25rem; /* Increases font size; adjust as needed */
            font-weight: bold;  /* Ensures text is bold */
          }
          

        .system-message {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .user-message {
            text-align: right;
        }
        
        .assistant-message {
            text-align: left;
        }
        
        #chat-messages {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            background-color: white;
        }
        
        .user-message p {
            display: inline-block;
            max-width: 70%;
            margin: 0;
            padding: 10px;
            background-color: #007bff;
            color: white;
            border-radius: 15px;
        }
        
        .assistant-message p {
            display: inline-block;
            max-width: 70%;
            margin: 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 15px;
        }

        .chat-container {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }

        .page-header {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url("{% static 'img/carousel-1.jpg' %}");
            background-position: center center;
            background-repeat: no-repeat;
            background-size: cover;
        }

        .symptom-section {
            margin-bottom: 15px;
            padding: 10px;
            border-left: 3px solid #007bff;
            background-color: #f8f9fa;
        }

        .section-title {
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .medical-disclaimer {
            font-style: italic;
            color: #dc3545;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 10px;
            border: 1px solid #dc3545;
            border-radius: 5px;
        }

        .urgent-notice {
            color: #dc3545;
            font-weight: bold;
        }

        .remedy-item {
            margin-bottom: 5px;
            padding-left: 20px;
            position: relative;
        }

        .remedy-item:before {
            content: "â€¢";
            position: absolute;
            left: 5px;
        }


        <style>
            .medicine-card {
                transition: transform 0.3s ease;
            }
            
            .medicine-card:hover {
                transform: translateY(-5px);
            }
            
            .modal-dialog {
                max-width: 800px;
            }
            
            .prescription-results {
                max-height: 70vh;
                overflow-y: auto;
            }
            
            .card-header {
                background: linear-gradient(45deg, #007bff, #0056b3);
            }
            
            .alert {
                border-left: 4px solid;
            }
            
            .alert-info {
                border-left-color: #17a2b8;
            }
            
            .alert-warning {
                border-left-color: #ffc107;
            }
            </style>

    </style>
</head>

<body>
   
     <!-- Navbar start -->
     <div class="container-fluid border-bottom bg-light wow fadeIn" data-wow-delay="0.1s">
        <div class="container px-0">
            <nav class="navbar navbar-light navbar-expand-xl py-3">
                <a href="{% url 'index' %}" class="navbar-brand">
                    <h2 class="text-primary display-6">Nurture<span class="text-secondary">Nest</span></h2>
                </a>
                <button class="navbar-toggler py-2 px-3" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse">
                    <span class="fa fa-bars text-primary"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarCollapse">
                    <div class="navbar-nav mx-auto">
                        <a href="{% url 'home' %}" class="nav-item nav-link active">Home</a>
                        <a href="{% url 'about' %}" class="nav-item nav-link">About</a>
                        <a href="{% url 'select_vaccine' %}" class="nav-item nav-link">Schedule Appointment</a>
                        <a href="{% url 'appointment_success' %}" class="nav-item nav-link">View Appointments</a>
                        
                        <!-- Replace the existing notification link with this -->
<a href="{% url 'notification' %}" class="nav-item nav-link position-relative">
    <i class="fas fa-bell"></i>
    {% if unread_notifications_count > 0 %}
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            {{ unread_notifications_count }}
        </span>
    {% endif %}
</a>
          
<div class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
        <i class="fa fa-hand-holding-heart"></i>
    </a>
    <div class="dropdown-menu m-0 bg-secondary rounded-0">
        <a href="{% url 'view_feedingchart' %}" class="dropdown-item">FeedingChart</a>
        <a href="{% url 'view_mentalhealth' %}" class="dropdown-item">Mental Health</a>
    </div>
</div>

 <!-- Shop Dropdown -->
 <div class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
        <i class="fas fa-shopping-bag"></i>
    </a>
    <div class="dropdown-menu m-0 bg-secondary rounded-0">
        <a href="{% url 'wishlist' %}" class="dropdown-item">
            <i class="far fa-heart me-2"></i>Wishlist
        </a>
        <a href="{% url 'cart' %}" class="dropdown-item">
            <i class="fas fa-shopping-cart me-2"></i>Cart
        </a>
        <a href="{% url 'my_orders' %}" class="dropdown-item">
            <i class="fas fa-history me-2"></i>Order History
        </a> 
       
    </div>
</div>
                        <div class="nav-item dropdown">
                            <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown">
                                <img src="{% static "img/name.png" %}" alt="Profile Picture" class="rounded-circle" width="30" height="30">
                                {{ user.get_full_name|default:user.username }}
                            </a>
                            <div class="dropdown-menu m-0 bg-secondary rounded-0">
                                <a href="{% url 'parent_profile' %}" class="dropdown-item">My Profile</a>
                                <a href="{% url 'vaccination_history' %}" class="dropdown-item">View Vaccination History</a>
                                <a href="{% url 'health_assistant_page' %}" class="nav-item nav-link">Health Assistant</a>
                                <a href="{% url 'toy_assistant' %}" class="nav-item nav-link">Toy Assistant</a>
                                <a href="{% url 'logout' %}" class="dropdown-item">Logout</a>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
        </div>
    </div>
    <!-- Navbar End -->


    <!-- Page Header Start -->
     
    <div class="container-fluid py-5 hero-header wow fadeIn" data-wow-delay="0.1s">
        <div class="container text-center py-5">
            <h1 class="display-3 text-white mb-4 animated slideInDown">Health Assistant</h1>
           <b> <p class="text-white mb-0">Your AI companion for health-related questions and prescription analysis</p></b>
        </div>
    </div>
    <!-- Page Header End -->


    <!-- Health Assistant Start -->
    <div class="container-fluid py-5 bg-light">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-8">
                    <div class="card shadow">
                        <div class="card-header bg-primary text-white">
                            <h4 class="mb-0">Health Assistant</h4>
                        </div>
                        <div class="card-body">
                            <!-- Chat Messages Area -->
                            <div id="chat-messages" class="mb-4" style="height: 400px; overflow-y: auto;">
                                <div class="system-message">
                                    <p class="mb-2">Hello! I can help you with:</p>
                                    <ul>
                                        <li>Vaccine information and schedules</li>
                                        <li>Common childhood diseases and symptoms</li>
                                        <li>Medicine information from prescriptions</li>
                                        <li>General health advice for children</li>
                                    </ul>
                                    <p class="mt-2 text-muted small">Note: This AI assistant provides general information only. Always consult with a healthcare professional for medical advice.</p>
                                </div>
                            </div>

                           <!-- Modal for Uploaded Medicine Information -->
 
  <div class="mb-3">
    <label for="prescription" class="form-label">Upload Prescription</label>
    <div class="input-group">
        <input type="file" class="form-control" id="prescription" accept="image/*">
        <button onclick="uploadPrescription()" class="btn btn-primary">
            <i class="fas fa-search"></i> Analyze
        </button>
    </div>
</div>

                            <!-- Chat Input -->
                            <div class="d-flex">
                                <input type="text" id="user-input" class="form-control me-2" 
                                    placeholder="Ask about vaccines, symptoms, or medicines...">
                                <button onclick="sendMessage()" class="btn btn-primary">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Health Assistant End -->


    <!-- Add Modal for Disease/Medicine Information -->
    <div class="modal fade" id="healthInfoModal" tabindex="-1" aria-labelledby="healthInfoModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="healthInfoModalLabel">Health Information</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="diseaseInfo" class="d-none">
                        <div class="mb-4">
                            <h6 class="text-primary">Disease/Condition</h6>
                            <p id="diseaseName" class="fw-bold"></p>
                            <p id="diseaseDescription"></p>
                        </div>
                        <div class="mb-4">
                            <h6 class="text-primary">Symptoms</h6>
                            <div id="diseaseSymptoms"></div>
                        </div>
                        <div class="mb-4">
                            <h6 class="text-primary">Causes</h6>
                            <div id="diseaseCauses"></div>
                        </div>
                        <div class="mb-4">
                            <h6 class="text-primary">Recommended Medicines</h6>
                            <div id="recommendedMedicines"></div>
                        </div>
                        <div class="mb-4">
                            <h6 class="text-primary">Precautions</h6>
                            <div id="diseasePrecautions"></div>
                        </div>
                        <div class="mb-4">
                            <h6 class="text-primary">Prevention Tips</h6>
                            <div id="preventionTips"></div>
                        </div>
                    </div>
                    <div id="medicineInfo" class="d-none">
                        <div class="mb-4">
                            <h6 class="text-primary">Medicine Details</h6>
                            <p id="medicineName" class="fw-bold"></p>
                            <p id="medicineDescription"></p>
                        </div>
                        <div class="mb-4">
                            <h6 class="text-primary">Usage & Dosage</h6>
                            <div id="medicineUsage"></div>
                        </div>
                        <div class="mb-4">
                            <h6 class="text-primary">Side Effects</h6>
                            <div id="medicineSideEffects"></div>
                        </div>
                        <div class="mb-4">
                            <h6 class="text-primary">Precautions</h6>
                            <div id="medicinePrecautions"></div>
                        </div>
                        <div class="mb-4">
                            <h6 class="text-primary">Treats Conditions</h6>
                            <div id="treatsConditions"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="medical-disclaimer w-100">
                        Note: This information is specifically for children under 15 years. Always consult a pediatrician before starting any medication.
                    </div>
                </div>
            </div>
        </div>
    </div>



 

    <!-- Copyright Start -->
        <div class="container-fluid copyright bg-dark py-4">
            <div class="container">
                <div class="row">
                    <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                        <span class="text-light"><a href="#"><i class="fas fa-copyright text-light me-2"></i>nurturenest@gmail.com</a>, All right reserved.</span>
                    </div>
                    <div class="col-md-6 my-auto text-center text-md-end text-white">
                        
                     
                    </div>
                </div>
            </div>
        </div>
    <!-- Copyright End -->

    <!-- JavaScript Libraries -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0/dist/js/bootstrap.bundle.min.js"></script>

   
    <!-- Chat JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('user-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const message = input.value.trim();
            
            if (message) {
                let loadingDiv = null; // Initialize loadingDiv variable
        
                try {
                    // Show user message
                    addMessageToChat('user', message);
                    input.value = '';
                    
                    // Show loading message
                    loadingDiv = addMessageToChat('system', 'Processing your request...');
                    
                    const response = await fetch('/health_assistant_api/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ message: message })
                    });
        
                    // Remove loading message if it exists
                    if (loadingDiv) {
                        loadingDiv.remove();
                    }
        
                    const data = await response.json();
                    console.log("Response from backend:", data); // Debugging
                    
                    if (data.error) {
                        addMessageToChat('system', data.error || 'An error occurred. Please try again.');
                        return;
                    }
                    
                    // Show AI response
                    addMessageToChat('assistant', data.response);
                    
                } catch (error) {
                    console.error('Error:', error);
                    // Remove loading message if it exists
                    if (loadingDiv) {
                        loadingDiv.remove();
                    }
                    addMessageToChat('system', 'Network error. Please check your connection and try again.');
                }
            }
        }
        
        function addMessageToChat(type, message) {
            const chatMessages = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `${type}-message mb-3`;
            
            const messageContent = document.createElement('div');
            messageContent.className = 'mb-1 p-3 rounded';
            
            if (type === 'user') {
                messageContent.className += ' bg-primary text-black text-end';
                messageContent.textContent = message;
            } else if (type === 'assistant') {
                messageContent.className += ' bg-light border';
                // Format the response with line breaks and bold text
                messageContent.innerHTML = formatResponse(message);
            } else {
                messageContent.className += ' bg-warning text-dark';
                messageContent.textContent = message;
            }
            
            messageDiv.appendChild(messageContent);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        
            return messageDiv; // Return the created messageDiv
        }
        
        function formatResponse(response) {
            // Replace newlines with <br> tags
            response = response.replace(/\n/g, '<br>');
            
            // Add bold formatting to key phrases
            const boldPhrases = [
                'What paracetamol is used for?',
                'The correct dosage?',
                'Possible side effects?',
                'Contraindications?',
                'Interactions with other medications?',
                'Paracetamol vs. other pain relievers?',
                'Something else entirely?',
                'General Information about Paracetamol (Acetaminophen):',
                'Important Considerations:',
                'Disclaimer:'
            ];
            
            boldPhrases.forEach(phrase => {
                response = response.replace(new RegExp(phrase, 'g'), `<strong>${phrase}</strong>`);
            });
            
            return response;
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
     {% comment %} Script for uploading image  {% endcomment %}
     <script>
        async function uploadPrescription() {
            const fileInput = document.getElementById('prescription');
            const file = fileInput.files[0];
            
            if (!file) {
                Swal.fire({
                    icon: 'warning',
                    title: 'No File Selected',
                    text: 'Please select a prescription image first'
                });
                return;
            }
        
            // Validate file type
            if (!file.type.startsWith('image/')) {
                Swal.fire({
                    icon: 'error',
                    title: 'Invalid File Type',
                    text: 'Please upload an image file (JPG, PNG, etc.)'
                });
                return;
            }

            // Show loading state
            Swal.fire({
                title: 'Analyzing Prescription',
                text: 'Please wait while we process your prescription...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            const formData = new FormData();
            formData.append('prescription', file);
        
            try {
                const response = await fetch('/upload_prescription/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });

                const data = await response.json();
        
                // Close loading state
                Swal.close();

                if (data.error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error
                    });
                    return;
                }

                if (!data.medicines || data.medicines.length === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'No Medicines Found',
                        text: 'No medicines were detected in the prescription. Please ensure the image is clear and contains medicine names.'
                    });
                    return;
                }

                // Display medicine details in a modal
                const medicineDetails = data.medicines.map(medicine => `
                    <div class="medicine-card mb-4 p-3 border rounded">
                        <h5 class="text-primary mb-3">${medicine.name}</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Usage:</strong> ${medicine.usage}</p>
                                <p><strong>Age Group:</strong> ${medicine.age_group}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Advantages:</strong> ${medicine.advantages}</p>
                                <p><strong>Side Effects:</strong> ${medicine.side_effects}</p>
                            </div>
                        </div>
                    </div>
                `).join('');

                // Update modal content
                document.getElementById('medicineDetails').innerHTML = medicineDetails;
                
                // Show the modal
                const medicineModal = new bootstrap.Modal(document.getElementById('medicineModal'));
                medicineModal.show();

               
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'An error occurred while processing the prescription. Please try again.'
                });
            }
        }
        
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        </script>


<!-- Add this CSS to your existing styles -->


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Add this modal for medicine details -->
    <div class="modal fade" id="medicineModal" tabindex="-1" aria-labelledby="medicineModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="medicineModalLabel">Medicine Information</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="medicineDetails">
                        <!-- Medicine details will be inserted here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="alert alert-warning mb-0">
                        <i class="fas fa-exclamation-triangle"></i>
                        Always consult with a healthcare professional before taking any medication.
                    </div>
                </div>
            </div>
        </div>
    </div>

</body>
</html>
